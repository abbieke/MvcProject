@using MvcProjectTest.ViewModels;
@using MvcProjectTest.Repositories;
@model List<ShoppingCartViewModel>
@{
    ViewBag.Title = "新知書櫥";
    Layout = "~/Views/Shared/_LayoutIndex.cshtml";
    int bookCount = 0;
    int total = 0;
    var _cusRepo = new CustomersRepository();
    var _shoppingRepo = new ShoppingRepository();
    if (Session["userid"] == null)
    {
        Session["userid"] = _cusRepo.GetCusromerID(User.Identity.Name);
    }
    var wishbooks = _shoppingRepo.SelectWish((int)Session["userid"]);



}





@Styles.Render("~/css/cartAndWishView")
<div class="container">
    <div class="cart-tab-block">
        <div class="shipping-status">
            <div class="container">
                <ul class="shipping-progress">
                    <li>購物車</li>
                    <li>運送資訊</li>
                    <li>訂單確認</li>
                    <li>訂單成立</li>
                </ul>
            </div>
        </div>

        <div id="cart-tab">
            <div class="cart-tab-title-row-block">
                <ul>
                    <li class="cart-tab-title-li">
                        <a href="#cart-tabs-1" class="cart-tab-text active">購物車</a>
                    </li>
                    <li class="cart-tab-title-li">
                        <a href="#cart-tabs-2" class="cart-tab-text">願望清單</a>
                    </li>
                </ul>
            </div>

            <!-- 購物車 -->
            <div id="cart-tabs-1" class="tab-inner">
                <div class="section">
                    <div class="cart-nav">
                        <ul>
                            <li>
                                <div class="switch">
                                    <input type="checkbox" id="switch" checked />
                                    <label for="switch"></label>
                                </div>
                            </li>
                            <li>結帳後清空</li>
                            <li><a href="#"><i class="fas fa-eraser"></i>清空購物車</a></li>
                        </ul>
                    </div>

                    <table>
                        <tr class="ordercheck-titlelist-height">
                            <th>
                                <input type="checkbox" id="all-check">
                                <label for="all-check">全選</label>
                            </th>
                            <th>商品圖片</th>
                            <th>商品名稱</th>
                            <th>數量</th>
                            <th>單價</th>
                            <th>變更</th>
                        </tr>
                        @foreach (var book in Model)
                        {

                            <tr class="ordercheck-list-height @("table-" + book.BookID)" field="@book.BookID">
                                <td class="item-checkbox-list">
                                    <input type="checkbox" class="checkbox-class" name=@(book.BookID + "/check") )>
                                </td>
                                <td class="cart-item-img">
                                    <div class="cart-item-imgbox"><img src=@book.BookImage alt=""></div>
                                </td>
                                <td class="item-name-list"><a href=@Url.Action("BookDetail", "Book", new { id = book.BookID })>@book.BooksName</a></td>
                                <td class="item-qty-list">
                                    <div class="prompt-block-about-stock">
                                        <form id='book1' method='POST' action='#'>
                                            <input type="hidden" name=@(book.BookID + "/inStock") value=@book.InStock />
                                            <input type='button' name=@(book.BookID + "/minus") value='-' class='qtyminus' />
                                            <input type='text' name=@(book.BookID + "/quantity") value=@book.Quantity class='qty' />
                                            <input type='button' name=@(book.BookID + "/plus") value='+' class='qtyplus' />
                                            <input type="hidden" name=@(book.BookID + "/discount") value=@book.Discount />
                                            <input type="hidden" name=@(book.BookID + "/unitprice") value=@book.UnitPrice />
                                        </form>
                                        <span class="instock-span">庫存：@book.InStock 個</span>
                                    </div>
                                </td>
                                <td class="item-price-list" field=@(book.BookID + "/price")>@((book.UnitPrice * (1-book.Discount)).ToString("0")) 元</td>
                                <td class="item-delete-list"><button class="remove-button" value="@book.BookID" field=@(book.BookID + "/remove")><i class="far fa-trash-alt"></i></button></td>
                            </tr>

                        }


                    </table>

                    <div class="cart-total-div">
                        <ul class="float-right">
                            <li>運費: <span>於下個步驟確認</span></li>
                            <li>總額: TWD <span id="total">@*@Model.Sum((p)=>Math.Round( p.UnitPrice*p.Quantity*(1-p.Discount)) )*@</span></li>
                        </ul>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12 text-center">
                            @Html.ActionLink("下一步，填寫資訊", "ShippingInfo", "Shopping", new { name = 666, year = 777 },
        new { @class = "btn btn-dark active", @role = "button", @style = "text-indent: 0;", })
                        </div>
                    </div>
                </div>
            </div>
            <!-- 願望清單 -->
            <div id="cart-tabs-2" class="tab-inner">
                <div class="product-card-list flex">
                    @foreach (var book in wishbooks)
                    {
                        @Html.Partial("_WishProductCardPartial", book)
                    }
                    @*<div class="product-card-out-block">
                            <div class="product-card-block">
                                <div class="product-card-img-block">
                                    <a href="#" class="product-link">
                                        <img class="pc-img"
                                             src="https://demoprestashop.aeipix.com/AX04/mybook75/img/p/1/0/8/108-home_default.jpg"
                                             alt="1">
                                    </a>
                                    <div class="product-card-visual-cart-block">
                                        <form action="add-cart">
                                            <input type="hidden" name="id" value="1">
                                            <!-- hidden的可以儲存資料用 根據後端修改 -->
                                            <button class="product-card-cart-button card-quick-button-style"
                                                    type="submit">
                                                <i class="fas fa-shopping-cart"></i>
                                                <span class="product-card-cart-tip pc-quick-tip-style">
                                                    Add To
                                                    Cart
                                                </span>
                                            </button>
                                        </form>
                                        <a href="#" class="product-card-quick-view">
                                            <i class="far fa-eye card-quick-button-style"></i>
                                            <span class="product-card-quick-view-tip pc-quick-tip-style">
                                                Quick
                                                View
                                            </span>
                                        </a>
                                    </div>
                                    <div class="wish-list-card-remove-icon-block">
                                        <a href="#" class="product-trash-icon-a">
                                            <i class="fas fa-trash-alt card-quick-button-style"></i>
                                            <span class="pc-quick-tip-style trash-quick-tip">Remove Wish</span>
                                        </a>
                                    </div>
                                </div>
                                <div class="product-card-description-block">
                                    <a href="#" class="product-link">
                                        <h3 class="product-card-title">
                                            有可能的任務
                                        </h3>
                                        <div class="product-writter-block">
                                            <span class="product-writter-span product-card-des-text">湯姆克魯斯</span>
                                        </div>
                                        <div class="product-price-block">
                                            <span class="product-price-span product-card-des-text">$300</span>
                                        </div>
                                    </a>
                                </div>
                            </div>

                        </div>*@
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts
{
    <script>
        $(function () {
            // $item_counts = $(".cart-items").find("table").length;
            $(window).scroll(function () {
                if ($(this).scrollTop() > 0) {          /* 要滑動到選單的距離 */
                    $('.dropdowns').addClass('navFixed');   /* 幫選單加上固定效果 */
                } else {
                    $('.dropdowns').removeClass('navFixed'); /* 移除選單固定效果 */
                }
            });
            // $(".scifiUI").height($(".scifiUI").height() + 80 * $item_counts);
            // console.log($item_counts, $(".scifiUI").height());
        });

        $(function () {
            $("#newest-tab").tabs();
            $("#cart-tab").tabs();
        });


    </script>


    @*刪除購物車商品*@
    <script>
    $(function () {
        $(".remove-button").click(removeButtonEvent);

        function removeButtonEvent() {
            var buttonValue = this.value;
            $.ajax({
                type: "POST",
                url: '@Url.Action("RemoveCartItem", "Shopping")',
                data: { customerId: @_cusRepo.GetCusromerID(User.Identity.Name), bookId: buttonValue }
            })
                .done(function () {
                    $(".table-" + buttonValue).remove();
                });
        }
    });

    </script>

    @*輸入數字限制*@
    @*<script>
    $(function () {
        $(".qty").keyup(qtyOnkeyupValue);
        //$(".qty").change(qtyOnkeyupValue);
        var isWarning = false;




        function qtyOnkeyupValue() {
            let id = $(this).attr("name").split("/")[0];
            var inStock = $("input[name='" + id + "/inStock']").val();
            //var inStock = $(this).siblings("input[name='inStock']").val();

            this.value = this.value.replace(/[^1-9]/g, '');
            if (parseInt(this.value) > parseInt(inStock)) {
                this.value = inStock;
            }

        };

        $(".qtyplus").click(function () {
            let id = $(this).attr("name").split("/")[0];
            var inStock = $("input[name='" + id + "/inStock']").val();
            var num = +$(this).siblings(".qty").val() + 1;

            $(this).siblings(".qty").val(function () {
                if (parseInt(num) > parseInt(inStock)) {

                    if (!isWarning) {
                        $(this).parent().siblings(".instock-span").html("數量不能超過庫存！");
                        $(this).parent().siblings(".instock-span").addClass("red-text-2");
                        isWarning = true;
                    }

                    return inStock;
                }
                else {
                    if (isWarning) {
                        $(this).parent().siblings(".instock-span").html("庫存：" + inStock);
                        $(this).parent().siblings(".instock-span").removeClass("red-text-2");
                        isWarning = false;
                    }
                    return num;
                };
            });
        });

        $(".qtyminus").click(function () {
            let id = $(this).attr("name").split("/")[0];
            var inStock = $("input[name='" + id + "/inStock']").val();
            var num = +$(this).siblings(".qty").val() - 1;

            $(this).siblings(".qty").val(function () {
                if (parseInt(num) <= 0) {
                    if (!isWarning) {
                        $(this).parent().siblings(".instock-span").html("數量不能小於1！");
                        $(this).parent().siblings(".instock-span").addClass("red-text-2");
                        isWarning = true;
                    }
                    return 1;
                }
                else {
                    if (isWarning) {
                        $(this).parent().siblings(".instock-span").html("庫存：" + inStock);
                        $(this).parent().siblings(".instock-span").removeClass("red-text-2");
                        isWarning = false;
                    }
                    return num;
                };
            });
        });

        @*剛進入時搜尋庫存與對應購物車數量*@
        @*此JS區塊暫時大量採樣順序，若商品區塊結構改變可能會需要調整*@
        @*var qty = document.getElementsByClassName("qty");

        for (var i = 0; i < qty.length; i++) {
            var inStock = qty[i].parentElement.children[0].value;
            var warningText = qty[i].parentElement.parentElement.children[1];

            if (inStock == 0) {
                let id = qty[i].getAttribute("name").split("/")[0];
                warningText.innerHTML = "目前商品已無庫存";
                warningText.classList.add("red-text-2");
                qty[i].removeAttribute("onkeyup");
                qty[i].disabled = true;
                qty[i].value = 0;
                qty[i].parentElement.parentElement.parentElement.parentElement.setAttribute(
                    "style", "background-color: #f7f7f7")
                //qty[i].parentElement.children[1].readOnly = true;
                qty[i].parentElement.children[1].disabled = true;
                qty[i].parentElement.children[1].removeAttribute("click");
                //qty[i].parentElement.children[3].readOnly = true;
                qty[i].parentElement.children[3].disabled = true;
                qty[i].parentElement.children[3].removeAttribute("click");
                document.getElementsByName(id + "/check")[0].disabled = true;
            }

            else if (parseInt(qty[i].value) > parseInt(inStock)) {
                warningText.innerHTML = "庫存數量不足，目前庫存：" + inStock;
                warningText.classList.add("red-text-2");
            }


        };


    });


    </script>*@


    @*總價邏輯*@
    <script>
        $(function () {
            var cartList = [];
            init();
            //setClickEvent();
            checkBoxChange();
            //valueChange();
            changeTotalDisplay();


            


            function init() {
                var itemList = document.getElementsByClassName("ordercheck-list-height");
                for (var index = 0; index < itemList.length; index++) {
                    let p_id = itemList[index].getAttribute("field");
                    let single_product = new singleProduct(
                        p_id, document.getElementsByName(p_id + "/unitprice")[0].value, document.getElementsByName(p_id + "/quantity")[0].value,
                        document.getElementsByName(p_id + "/discount")[0].value, false);
                    cartList.push(single_product);
                }
            }

            function singleProduct(productId, unitprice, quantity, discount, isCheck) {
                this.productId = productId;
                this.unitprice = parseInt(unitprice);
                this.quantity = parseInt(quantity);
                this.discount = parseFloat(discount);
                this.isCheck = isCheck;
                this.thisProductTotal = thisProductTotal;
            }

            function thisProductTotal() {
                let result = Math.round(this.unitprice * this.quantity * (1 - this.discount));
                return result;
            }

            function cartList_findIndex(productId) {
                for (var index = 0; index < cartList.length; index++) {
                    if (cartList[index].productId == productId) {
                        return index;
                    }
                }
            }

            //算總價
            function changeTotalDisplay() {
                var total = 0;
                cartList.forEach(function (element) {
                    if (element.isCheck) {
                        total += element.thisProductTotal();
                    }
                });
                $("#total").html(total);
            }

            function valueChange() {

                $(".qty").change(function () {

                    var id = $(this).attr("name").split("/")[0];
                    var listIndex = cartList_findIndex(id);
                    cartList[listIndex].quantity = $(this).val();
                    changeTotalDisplay();
                });

            }

            function valueChangeEvent() {

            }

            function checkBoxChange() {
                $(".checkbox-class").change(function () {
                    var id = $(this).attr("name").split("/")[0];
                    var listIndex = cartList_findIndex(id);
                    cartList[listIndex].isCheck = !(cartList[listIndex].isCheck);

                    changeTotalDisplay();
                });
            }


            //全選功能 先用芷婷的
            $(".checkbox-class").click(cheaked);
            $("#all-check").click(first);

            function first() {
                var as = document.getElementsByClassName("checkbox-class");
                var a1 = document.getElementById("all-check");
                for (var i = 0; i < as.length; i++) {
                    if (!as[i].disabled) {
                        as[i].checked = a1.checked;
                        let id = as[i].name.split("/")[0];
                        let listIndex = cartList_findIndex(id);
                        cartList[listIndex].isCheck = !(cartList[listIndex].isCheck);
                    }

                }
                changeTotalDisplay();
            }
            function cheaked() {
                var count = 0;
                var aa = document.getElementById("all-check");
                var aa1 = document.getElementsByClassName("checkbox-class");
                for (var i = 0; i < aa1.length; i++) {
                    if (aa1[i].checked) {
                        count += 1;
                        if (count == aa1.length) {
                            aa.checked = true;
                        } else {
                            aa.checked = false;
                        }
                    }
                }
                changeTotalDisplay();
            }


            //加減與輸入控管邏輯 先忽略整合到上面的JS物件系統

            $(".qty").keyup(qtyOnkeyupValue);
        //$(".qty").change(qtyOnkeyupValue);
        var isWarning = false;




        function qtyOnkeyupValue() {
            let id = $(this).attr("name").split("/")[0];
            var inStock = $("input[name='" + id + "/inStock']").val();
            //var inStock = $(this).siblings("input[name='inStock']").val();

            this.value = this.value.replace(/[^1-9]/g, '');
            if (parseInt(this.value) > parseInt(inStock)) {
                this.value = inStock;
            }
                let listIndex = cartList_findIndex(id);
                cartList[listIndex].quantity = $(this).val();
            changeTotalDisplay();
        };

        $(".qtyplus").click(function () {
            let id = $(this).attr("name").split("/")[0];
            var inStock = $("input[name='" + id + "/inStock']").val();
            var num = +$(this).siblings(".qty").val() + 1;

            $(this).siblings(".qty").val(function () {
                if (parseInt(num) > parseInt(inStock)) {

                    if (!isWarning) {
                        $(this).parent().siblings(".instock-span").html("數量不能超過庫存！");
                        $(this).parent().siblings(".instock-span").addClass("red-text-2");
                        isWarning = true;
                    }
                    let listIndex = cartList_findIndex(id);
                    cartList[listIndex].quantity = inStock;
                    changeTotalDisplay();
                    return inStock;
                }
                else {
                    if (isWarning) {
                        $(this).parent().siblings(".instock-span").html("庫存：" + inStock);
                        $(this).parent().siblings(".instock-span").removeClass("red-text-2");
                        isWarning = false;
                    }
                let listIndex = cartList_findIndex(id);
                cartList[listIndex].quantity = num;
                    changeTotalDisplay();
                    return num;
                };
            });
        });

        $(".qtyminus").click(function () {
            let id = $(this).attr("name").split("/")[0];
            var inStock = $("input[name='" + id + "/inStock']").val();
            var num = +$(this).siblings(".qty").val() - 1;

            $(this).siblings(".qty").val(function () {
                if (parseInt(num) <= 0) {
                    if (!isWarning) {
                        $(this).parent().siblings(".instock-span").html("數量不能小於1！");
                        $(this).parent().siblings(".instock-span").addClass("red-text-2");
                        isWarning = true;
                    }
                let listIndex = cartList_findIndex(id);
                cartList[listIndex].quantity = 1;
                    changeTotalDisplay();
                    return 1;
                }
                else {
                    if (isWarning) {
                        $(this).parent().siblings(".instock-span").html("庫存：" + inStock);
                        $(this).parent().siblings(".instock-span").removeClass("red-text-2");
                        isWarning = false;
                    }
                let listIndex = cartList_findIndex(id);
                cartList[listIndex].quantity = num;
                    changeTotalDisplay();
                    return num;
                };
            });
        });

        @*剛進入時搜尋庫存與對應購物車數量*@
        @*此JS區塊暫時大量採樣順序，若商品區塊結構改變可能會需要調整*@
            //因為進度關係也先不去整合到上面JS物件總價
        var qty = document.getElementsByClassName("qty");

        for (var i = 0; i < qty.length; i++) {
            var inStock = qty[i].parentElement.children[0].value;
            var warningText = qty[i].parentElement.parentElement.children[1];

            if (inStock == 0) {
                let id = qty[i].getAttribute("name").split("/")[0];
                warningText.innerHTML = "目前商品已無庫存";
                warningText.classList.add("red-text-2");
                qty[i].removeAttribute("onkeyup");
                qty[i].disabled = true;
                qty[i].value = 0;
                qty[i].parentElement.parentElement.parentElement.parentElement.setAttribute(
                    "style", "background-color: #f7f7f7")
                //qty[i].parentElement.children[1].readOnly = true;
                qty[i].parentElement.children[1].disabled = true;
                qty[i].parentElement.children[1].removeAttribute("click");
                //qty[i].parentElement.children[3].readOnly = true;
                qty[i].parentElement.children[3].disabled = true;
                qty[i].parentElement.children[3].removeAttribute("click");
                document.getElementsByName(id + "/check")[0].disabled = true;
            }

            else if (parseInt(qty[i].value) > parseInt(inStock)) {
                warningText.innerHTML = "庫存數量不足，目前庫存：" + inStock;
                warningText.classList.add("red-text-2");
            }


        };

            // 寫到一半先不管
            //function allCheckChange() {
            //    $("#all-check").change(function () {
            //        if ($(this).attr("checked") == "checked") {
            //            alert("aaa");
            //        }
            //    });
            //}

            //function setClickEvent() {
            //    all_check_click();
            //    $(".checkbox-class").click(singleCheck_click);
            //}

            //function all_check_click() {
            //    $("#all-check").click(function () {
            //        if ($("#all-check").attr("checked")=="checked") {

            //            $(".checkbox-class").attr("checked", false);
            //            $(this).attr("checked", false);

            //        }
            //        else {
            //            $(".checkbox-class").attr("checked", true);
            //            $(this).attr("checked", true);

            //        }
            //    })
            //};

            //function singleCheck_click() {

            //    if ($(this).attr("checked") == "checked") {
            //        $(this).attr("checked", false);
            //    }
            //    else {
            //        $(this).attr("checked", true);
            //    }

            //}



        })






    </script>



}

